# https://github.com/marketplace/actions/zap-full-scan
on:
  workflow_call:
    inputs:
      dast-scan-tool: { type: string, required: true }
      language: { type: string, required: false }
      project_dir: { type: string, required: true }
      environment: { type: string, required: true }
      start_command: { type: string, required: true }
      website_target: { type: string, required: true }

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  zap_scan:
    runs-on: ubuntu-latest
    name: Scan the webapplication
    steps:
      - name: Checkout
        uses: actions/checkout@v4
#        with:
#          ref: main

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install -r requirements.txt
            
      - name: Start Application
        run: |
          ${{ inputs.start_command }} &
          timeout 60 bash -c "until curl -s http://localhost:8000; do sleep 2; done"

      - name: Check app is running
        run: curl -v http://localhost:8000 || exit 1
      
      - name: ZAP Scan
        uses: zaproxy/action-full-scan@v0.12.0
        with:
          target: '${{ inputs.website_target }}'
          # target: 'https://www.zaproxy.org/'
          # target: 'http://localhost:8080'

#      - name: ZAP Scan
#        uses: zaproxy/action-full-scan@v0.12.0
#        with:
#          token: ${{ secrets.GITHUB_TOKEN }}
#          docker_name: 'ghcr.io/zaproxy/zaproxy:stable'
#          target: 'http://localhost:8080'
#          rules_file_name: '.zap/rules.tsv'
#          cmd_options: '-a'
