on:
  workflow_call:
    inputs:
      scantool: { type: string, required: true }
#      language: { type: string, required: true }
      project_dir: { type: string, required: true }
      environment: { type: string, required: true }
    secrets:
      BEARER_TOKEN: { required: false }

permissions:
  actions: read
  contents: read
  security-events: write
 
jobs:
  generate-timestamp:
    uses: ./.github/workflows/generate-timestamp.yml

  rule_check:
    runs-on: ubuntu-latest
    # continue-on-error: ${{ inputs.environment == 'non-prod' }}
    steps:
      - uses: actions/checkout@v3
      - name: Run Report
        id: report
        uses: bearer/bearer-action@v2
        with:
          format: sarif
          output: bearer-results-${{ needs.generate-timestamp.outputs.timestamp }}.sarif
        
  bearer_scan:
    runs-on: ubuntu-latest
    needs: generate-timestamp
    steps:
      - uses: actions/checkout@v3
      
      - name: Run Bearer scan (SARIF output)
        uses: bearer/bearer-action@v2
        with:
          format: sarif
          output: bearer-results-${{ needs.generate-timestamp.outputs.timestamp }}.sarif
          path: ${{ inputs.project_dir }}
        continue-on-error: ${{ inputs.environment == 'non-prod' }}
  
      - name: Upload SARIF file to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: bearer-results-${{ needs.generate-timestamp.outputs.timestamp }}.sarif
  
      - name: Upload SARIF file as artifact
        uses: actions/upload-artifact@v4
        with:
          name: bearer-sarif-scan
          path: bearer-results-${{ needs.generate-timestamp.outputs.timestamp }}.sarif
