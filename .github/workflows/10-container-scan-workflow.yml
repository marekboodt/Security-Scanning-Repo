name: Container Scan - Trivy

on:
  workflow_call:
    inputs:
      image-name: { type: string, required: true }
      image-tag: { type: string, required: true }
      dockerfile-path: { type: string, required: true }
      exception-profile: { type: string, required: false, default: 'none' }
      severity: { type: string, required: false, default: 'HIGH,CRITICAL' }
      environment: { type: string, required: true }

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  generate-timestamp:
    uses: ./.github/workflows/00-generate-timestamp.yml
  
  trivy-scan:
    runs-on: ubuntu-latest
    needs: generate-timestamp
    steps:
      - uses: actions/checkout@v4
      
      # Checkout centrale exceptions repo
      - name: Checkout central exceptions
        uses: actions/checkout@v4
        with:
          repository: marekboodt/Security-Scanning-Repo
          path: central-exceptions
          sparse-checkout: |
            trivy-exceptions/
      
      # Merge ignore files
      - name: Merge trivyignore files
        run: |
          touch .trivyignore-merged
          
          # 1. Globale exceptions
          if [ -f "central-exceptions/trivy-exceptions/global.trivyignore" ]; then
            echo "# Global exceptions" >> .trivyignore-merged
            cat central-exceptions/trivy-exceptions/global.trivyignore >> .trivyignore-merged
            echo "" >> .trivyignore-merged
          fi
          
          # 2. Base-image exceptions
          if [ "${{ inputs.exception-profile }}" != "none" ] && [ -f "central-exceptions/trivy-exceptions/${{ inputs.exception-profile }}.trivyignore" ]; then
            echo "# Exception profile (${{ inputs.exception-profile }})" >> .trivyignore-merged
            cat central-exceptions/trivy-exceptions/${{ inputs.exception-profile }}.trivyignore >> .trivyignore-merged
            echo "" >> .trivyignore-merged
          fi
          
          # 3. Project-specifieke exceptions
          if [ -f ".trivyignore" ]; then
            echo "# Project specific exceptions" >> .trivyignore-merged
            cat .trivyignore >> .trivyignore-merged
          fi
          
          echo "=== Merged trivyignore file ==="
          cat .trivyignore-merged
      
      - name: Build image
        run: docker build -t ${{ inputs.image-name }}:${{ inputs.image-tag }} ${{ inputs.dockerfile-path }}
      
      - name: Run Trivy scan (table)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ inputs.image-name }}:${{ inputs.image-tag }}'
          format: 'table'
          severity: ${{ inputs.severity }}
          trivyignores: '.trivyignore-merged'
      
      - name: Run Trivy scan (SARIF)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: '${{ inputs.image-name }}:${{ inputs.image-tag }}'
          format: 'sarif'
          output: 'trivy-results-${{ needs.generate-timestamp.outputs.timestamp }}.sarif'
          severity: ${{ inputs.severity }}
          trivyignores: '.trivyignore-merged'

      - name: Upload SARIF file to DOWNLOAD
        uses: actions/upload-artifact@v4
        with:
          name: trivy-results-${{ needs.generate-timestamp.outputs.timestamp }}
          path: trivy-results-${{ needs.generate-timestamp.outputs.timestamp }}.sarif

      - name: Upload SARIF to SECURITY TAB (GITHUB)
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: trivy-results-${{ needs.generate-timestamp.outputs.timestamp }}.sarif
          category: trivy-container-scan
