name: Reusable DAST Workflow

on:
  workflow_call:
    inputs:
      dast-scan-tool: { type: string, required: true }
      language:       { type: string, required: false }
      project_dir:    { type: string, required: true }
      environment:    { type: string, required: true }
      start_command:  { type: string, required: false, default: "" }
      website_target: { type: string, required: true }
      # NEW: containerized target
      service_image:  { type: string, required: false }
      container_port: { type: number, required: false }
      health_path:    { type: string, required: false, default: "/" }
      env_json:       { type: string, required: false, default: "{}" }
      scan_type:      { type: string, required: false, default: "baseline" }
      cmd_options:    { type: string, required: false, default: "-x report_xml.xml" }
  workflow_dispatch:

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  ZAP-Scan:
    if: ${{ inputs.dast-scan-tool == 'zap' }}
    uses: ./.github/workflows/test_21-dast-zap-workflow.yml
    with:
      dast-scan-tool: ${{ inputs.dast-scan-tool }}
      project_dir:    ${{ inputs.project_dir }}
      environment:    ${{ inputs.environment }}
      start_command:  ${{ inputs.start_command }}
      website_target: ${{ inputs.website_target }}
      service_image:  ${{ inputs.service_image }}
      container_port: ${{ inputs.container_port }}
      health_path:    ${{ inputs.health_path }}
      env_json:       ${{ inputs.env_json }}
      scan_type:      ${{ inputs.scan_type }}
      cmd_options:    ${{ inputs.cmd_options }}

  Cloudflare-Scan:
    if: ${{ inputs.dast-scan-tool == 'cloudflare' }}
    uses: ./.github/workflows/test_29-dast-cloudflare-exception.yml
    with:
      website_target: ${{ inputs.website_target }}
      environment:    ${{ inputs.environment }}
